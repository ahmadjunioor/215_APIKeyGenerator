<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN DASHBOARD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Rajdhani:wght@500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --val-red: #ff4655;
            --val-black: #0f1923;
            --val-dark: #1f2326;
            --val-white: #ece8e1;
        }

        body {
            background-color: var(--val-black);
            font-family: 'Kanit', sans-serif;
            color: white;
            min-height: 100vh;
        }

        /* Navbar Sederhana */
        .val-navbar {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 20px 0;
            background: rgba(15,25,35,0.9);
        }

        h1 {
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 2.5rem;
        }

        .card {
            background: transparent;
            border: none;
        }

        /* Custom Table Valorant Style */
        .table-responsive {
            background-color: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .table {
            color: #fff;
            margin-bottom: 0;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
        }

        .table thead th {
            background-color: rgba(255,255,255,0.05);
            color: var(--val-gray);
            font-weight: 700;
            text-transform: uppercase;
            border-bottom: 2px solid var(--val-red);
            padding: 15px;
            letter-spacing: 1px;
        }

        .table tbody td {
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 15px;
            vertical-align: middle;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(255, 70, 85, 0.1); /* Highlight Merah saat hover */
        }

        /* Status & Key Styling */
        .api-key-cell {
            color: var(--val-red);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .badge {
            border-radius: 2px;
            padding: 5px 10px;
            text-transform: uppercase;
            font-weight: 700;
            font-size: 0.8rem;
        }

        .bg-success {
            background-color: rgba(50, 255, 150, 0.2) !important;
            color: #32ff96;
            border: 1px solid #32ff96;
        }

        .bg-secondary {
            background-color: rgba(150, 150, 150, 0.2) !important;
            color: #ccc;
            border: 1px solid #888;
        }

        /* Logout Button */
        .btn-outline-danger {
            color: var(--val-red);
            border-color: var(--val-red);
            border-radius: 0;
            font-weight: bold;
            text-transform: uppercase;
        }

        .btn-outline-danger:hover {
            background-color: var(--val-red);
            color: white;
        }

        .alert {
            background: rgba(255, 70, 85, 0.1);
            border: 1px solid var(--val-red);
            color: var(--val-red);
            border-radius: 0;
        }
    </style>
</head>
<body>

    <div class="val-navbar">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">ADMIN <span style="color:var(--val-red)">PANEL</span></h1>
                <small style="color:#8b9bb4; letter-spacing:1px; font-family:'Rajdhani'">> SYSTEM: User & API Key Management Module</small>
            </div>
            <button id="logoutBtn" class="btn btn-outline-danger px-4">
              { X } EXIT 
            </button>
        </div>
    </div>

    <div class="container py-5">
        
        <div id="statusMessage" class="alert text-center">
            SYNCING DATA...
        </div>

        <div class="card">
            <div class="card-body p-0 table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#ID</th>
                            <th>USER NAME</th>
                            <th>EMAIL ADDRESS</th>
                            <th>API ACCESS KEY</th>
                            <th>STATUS</th>
                            <th>VALID UNTIL</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="text-center mt-5">
            <small style="color: #555; font-family: 'Rajdhani'">@ 2025</small>
        </div>
    </div>

    <script>
        const API_USERS_URL = 'http://localhost:3000/admin/users'; 
        
        const token = localStorage.getItem('adminToken');
        const statusMessage = document.getElementById('statusMessage');
        const usersTableBody = document.getElementById('usersTableBody');
        
        if (!token) {
            window.location.href = 'admin_login.html';
        } else {
            fetchUserData(token);
        }

        async function fetchUserData(jwtToken) {
            try {
                const response = await fetch(API_USERS_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('adminToken');
                    alert("SESSION EXPIRED");
                    window.location.href = 'admin_login.html';
                    return;
                }

                const data = await response.json();

                if (response.ok) {
                    statusMessage.style.display = 'none';
                    renderTable(data);
                } else {
                    statusMessage.textContent = `ERROR: ${data.message || 'FAILED'}`;
                }

            } catch (error) {
                console.error(error);
                statusMessage.textContent = "SERVER UNREACHABLE";
            }
        }

        function renderTable(users) {
            usersTableBody.innerHTML = '';
            
            if (users.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">NO AGENTS FOUND</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = usersTableBody.insertRow();
                
                const rawDate = user.OUT_OF_DATE || user.out_of_date;
                const expiryDate = rawDate ? new Date(rawDate).toLocaleDateString('id-ID', { 
                    day: 'numeric', month: 'short', year: 'numeric' 
                }).toUpperCase() : '-';

                const statusRaw = user.STATUS || user.status; 
                let statusBadge = '';
                let statusText = '';

                if (statusRaw === 'Active') {
                    statusBadge = 'bg-success';
                    statusText = 'ONLINE';
                } else {
                    statusBadge = 'bg-secondary';
                    statusText = 'OFFLINE';
                }

                const id = user.id || user.ID; 
                const firstName = user.FIRST_NAME || user.first_name;
                const lastName = user.LAST_NAME || user.last_name;
                const email = user.EMAIL || user.email;
                const keyValue = user.KEY_VALUE || user.key_value;

                row.innerHTML = `
                    <td class="fw-bold text-secondary">${id}</td>
                    <td class="text-uppercase fw-bold">${firstName} ${lastName}</td>
                    <td>${email}</td>
                    <td><span class="api-key-cell">${keyValue}</span></td>
                    <td><span class="badge ${statusBadge}">${statusText}</span></td>
                    <td style="color:#8b9bb4">${expiryDate}</td>
                `;
            });
        }
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>